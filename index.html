<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Odd or Even Cricket Game</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body class="dark">
  <div class="container" id="main-container">

    <!-- Login Section -->
    <div id="login-section" class="center-buttons">
      <p>Please log in to continue:</p>
      <input type="text" id="playerName" placeholder="Enter Name" />
      <input type="email" id="playerEmail" placeholder="Enter Email" />
      <button onclick="loginPlayer()">Login</button>
    </div>

    <div class="top-controls">
      <button onclick="toggleDifficulty()">üß† Difficulty</button>
      <button onclick="toggleTheme()">üé® Change Theme</button>
    </div>

    <h2>Odd or Even Cricket Game</h2>

    <div id="message-box">Welcome! Please login first.</div>

    <div class="difficulty-box hidden" id="difficulty-box">
      <p>Select difficulty level:</p>
      <button onclick="setDifficulty('easy')" id="easy-btn">Easy</button>
      <button onclick="setDifficulty('medium')" id="medium-btn">Medium</button>
      <button onclick="setDifficulty('hard')" id="hard-btn">Hard</button>
    </div>

    <div id="toss-section" class="center-buttons hidden">
      <button onclick="toss('head')">HEAD</button>
      <button onclick="toss('tails')">TAILS</button>
    </div>

    <div id="choice-section" class="center-buttons hidden">
      <p>Choose your role:</p>
      <button onclick="setChoice('batting')">Batting</button>
      <button onclick="setChoice('bowling')">Bowling</button>
    </div>

    <div id="game-section" class="hidden">
      <div id="game-status"></div>
      <div class="center-buttons">
        <input type="number" id="player-run" min="0" max="10" placeholder="0‚Äì10" />
        <button onclick="playRound()">Play</button>
      </div>

      <div class="choices-display">
        <div>Your choice: <span id="player-choice-display">-</span></div>
        <div>Computer choice: <span id="computer-choice-display">-</span></div>
      </div>

      <div class="scoreboard">
        <div>Your Score: <span id="player-score">0</span></div>
        <div>Computer Score: <span id="computer-score">0</span></div>
      </div>
    </div>

    <div class="center-buttons">
      <button onclick="resetGame()" class="reset-btn">üîÅ Reset Game</button>
      <button id="screenshot-btn" onclick="captureAndShare()" class="screenshot-btn">üì∏ Share Screenshot</button>
      <a id="share-btn" target="_blank">üì§ Share via WhatsApp</a>
    </div>

    <audio id="clapssound" src="https://www.soundjay.com/human/sounds/applause-01.mp3"></audio>
    <audio id="losinghorn" src="https://www.soundjay.com/button/beep-07.mp3"></audio>
  </div>

  <div id="popup-container"></div>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbyZUq54BgETfe1Ro9eTDrGv-FoWPvo_Kdis33knPvJm-FzhW1jHSFGnaQoewCU_HhSBqg/exec";

    let playerName = "";
    let playerEmail = "";

    function loginPlayer() {
      playerName = document.getElementById("playerName").value.trim();
      playerEmail = document.getElementById("playerEmail").value.trim();

      if (!playerName || !playerEmail) {
        alert("Please enter both name and email.");
        return;
      }

      fetch(SHEET_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          name: playerName,
          email: playerEmail,
          device: navigator.userAgent,
          score: "Not Played Yet"
        })
      })
      .then(res => res.json())
      .then(data => {
        // Hide login, show toss
        document.getElementById("login-section").classList.add("hidden");
        document.getElementById("toss-section").classList.remove("hidden");
        document.getElementById("message-box").innerText = `Welcome ${playerName}! Choose HEAD or TAILS to start the toss.`;
      })
      .catch(err => {
        console.error("Login error:", err);
        alert("Login failed, try again.");
      });
    }

    function logScore(finalScore) {
      if (!playerName || !playerEmail) return; // avoid sending if not logged in

      fetch(SHEET_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          name: playerName,
          email: playerEmail,
          device: navigator.userAgent,
          score: finalScore
        })
      })
      .then(res => res.json())
      .then(data => {
        console.log("Score logged:", data);
      })
      .catch(err => {
        console.error("Error logging score:", err);
      });
    }

    // The rest of your game code follows, inside a class or otherwise
    class HandCricketGame {
      constructor() {
        this.difficulty = 'easy';
        this.themeClickCount = 0;
        this.p_run = 0;
        this.c_run = 0;
        this.playerChoice = '';
        this.gamePhase = 'toss';
        this.secondPhase = false;
        this.prevMoves = [];
        this.sameChoiceCount = 0;
        this.lastPlayerInput = null;
        this.target = null;

        this.initializeElements();
        this.bindEvents();
      }

      initializeElements() {
        this.playerRunInput = document.getElementById('player-run');
        this.playerScoreDisplay = document.getElementById('player-score');
        this.computerScoreDisplay = document.getElementById('computer-score');
        this.playerChoiceDisplay = document.getElementById('player-choice-display');
        this.computerChoiceDisplay = document.getElementById('computer-choice-display');
        this.messageBox = document.getElementById('message-box');
        this.gameStatus = document.getElementById('game-status');
        this.shareBtn = document.getElementById('share-btn');
        this.screenshotBtn = document.getElementById('screenshot-btn');
        this.container = document.getElementById('main-container');
      }

      bindEvents() {
        document.addEventListener("keydown", (e) => {
          if (e.key === "Enter") this.playRound();
          if (e.key === "Shift") this.resetGame();
        });
      }

      toggleTheme() {
        const body = document.body;
        this.themeClickCount++;
        if (this.themeClickCount === 9) {
          body.className = 'rainbow';
          this.showPopup("üåà Rainbow Theme Unlocked!");
        } else {
          const themes = ['dark', 'light', 'purple'];
          const current = themes.indexOf(body.className);
          body.className = themes[(current + 1) % themes.length];
        }
      }

      toggleDifficulty() {
        const box = document.getElementById("difficulty-box");
        box.classList.toggle("hidden");
      }

      setDifficulty(level) {
        this.difficulty = level;
        document.getElementById("difficulty-box").classList.add("hidden");
        ["easy", "medium", "hard"].forEach(id => {
          document.getElementById(`${id}-btn`).classList.remove("selected");
        });
        document.getElementById(`${level}-btn`).classList.add("selected");
      }

      toss(playerToss) {
        const compToss = Math.random() < 0.5 ? 'head' : 'tails';
        if (playerToss === compToss) {
          this.messageBox.innerHTML = `You chose <strong>${playerToss}</strong>, Computer chose <strong>${compToss}</strong>.<br>You won the toss! Choose to Bat or Bowl.`;
          document.getElementById('toss-section').classList.add('hidden');
          document.getElementById('choice-section').classList.remove('hidden');
        } else {
          const compRole = Math.random() < 0.5 ? 'batting' : 'bowling';
          this.playerChoice = (compRole === 'batting') ? 'bowling' : 'batting';
          this.gamePhase = this.playerChoice;
          this.messageBox.innerHTML = `Computer won the toss and chose to ${compRole}. You are ${this.playerChoice}.`;
          document.getElementById('toss-section').classList.add('hidden');
          setTimeout(() => this.startGame(), 1500);
        }
      }

      setChoice(choice) {
        this.playerChoice = choice;
        this.gamePhase = choice;
        document.getElementById('choice-section').classList.add('hidden');
        this.startGame();
      }

      startGame() {
        document.getElementById('game-section').classList.remove('hidden');
        this.gameStatus.textContent = `You are ${this.playerChoice}${this.secondPhase ? " (2nd Innings)" : ""}`;
        this.playerRunInput.focus();
      }

      generateComputerMove() {
        if (this.difficulty === 'easy') return Math.floor(Math.random() * 11);

        if (this.difficulty === 'medium') {
          const bias = Math.random() < 0.3 ?
            this.prevMoves[this.prevMoves.length - 1] || Math.floor(Math.random() * 11) :
            Math.floor(Math.random() * 11);
          return Math.max(0, Math.min(10, bias));
        }

        if (this.difficulty === 'hard') {
          const freq = {};
          this.prevMoves.forEach(n => freq[n] = (freq[n] || 0) + 1);
          const sorted = Object.entries(freq).sort((a, b) => b[1] - a[1]);
          const predict = sorted.length ? parseInt(sorted[0][0]) : Math.floor(Math.random() * 11);
          return Math.max(0, Math.min(10, predict + (Math.random() < 0.5 ? 0 : (Math.random() < 0.5 ? 1 : -1))));
        }
      }

      playRound() {
        const val = parseInt(this.playerRunInput.value);
        if (isNaN(val) || val < 0 || val > 10) {
          this.messageBox.innerText = "Enter a number between 0 and 10.";
          return;
        }

        if (val === this.lastPlayerInput) {
          this.sameChoiceCount++;
          if (this.sameChoiceCount === 3) this.showPopup("‚ö† Warning: Don't repeat the same number!");
          if (this.sameChoiceCount === 4) this.showPopup("üò¨ Be careful! Repeating again will get you OUT!");
        } else {
          this.sameChoiceCount = 1;
          this.lastPlayerInput = val;
        }

        // OUT by repetition rule
        if (this.sameChoiceCount >= 5 && this.gamePhase === 'batting') {
          this.messageBox.innerHTML = "‚ùå You used the same number 5 times! You're out!";
          document.getElementById('losinghorn').play();
          this.animateOut();
          if (!this.secondPhase) {
            this.target = this.p_run;
            this.secondPhase = true;
            this.playerChoice = 'bowling';
            this.gamePhase = 'bowling';
            this.messageBox.innerText = `You are out! Now Bowling ‚Äì Defend your score (${this.target})!`;
            setTimeout(() => this.startGame(), 1000);
          } else {
            this.checkSecondInningsEnd(true);
          }
          this.playerRunInput.value = '';
          return;
        }

        const comp = this.generateComputerMove();
        const isOut = val === comp;
        this.prevMoves.push(val);
        this.playerChoiceDisplay.textContent = val;
        this.computerChoiceDisplay.textContent = comp;

        if (this.gamePhase === 'batting') {
          if (isOut) {
            document.getElementById('losinghorn').play();
            this.animateOut();
            if (!this.secondPhase) {
              this.target = this.p_run;
              this.secondPhase = true;
              this.playerChoice = 'bowling';
              this.gamePhase = 'bowling';
              this.messageBox.innerText = `You are out! Now Bowling ‚Äì Defend your score (${this.target})!`;
              setTimeout(() => this.startGame(), 1000);
            } else {
              this.checkSecondInningsEnd(true);
            }
          } else {
            this.p_run += (val === 0 ? comp : val);
            this.updateScores();
            if (this.secondPhase) {
              if (this.p_run > this.c_run) {
                this.win();
                return;
              } else if (this.p_run === this.c_run) {
                this.win();
                return;
              }
            }
          }
        } else { // bowling
          if (isOut) {
            document.getElementById('losinghorn').play();
            this.animateOut();
            if (!this.secondPhase) {
              this.target = this.c_run;
              this.secondPhase = true;
              this.playerChoice = 'batting';
              this.gamePhase = 'batting';
              this.messageBox.innerText = `Computer is out! Now Batting ‚Äì Chase the score (${this.target})!`;
              setTimeout(() => this.startGame(), 1000);
            } else {
              this.checkSecondInningsEnd(true);
            }
          } else {
            this.c_run += comp;
            this.updateScores();
            if (this.secondPhase) {
              if (this.c_run > this.p_run) {
                this.lose();
                return;
              } else if (this.c_run === this.p_run) {
                this.lose();
                return;
              }
            }
          }
        }

        this.playerRunInput.value = '';
      }

      checkSecondInningsEnd(isOut) {
        if (this.playerChoice === 'batting') {
          if (this.p_run === this.target) this.endGame('tie');
          else this.lose();
        } else {
          if (this.c_run === this.target) this.endGame('tie');
          else this.win();
        }
      }

      updateScores() {
        this.playerScoreDisplay.textContent = this.p_run;
        this.computerScoreDisplay.textContent = this.c_run;
      }

      endGame(result = null) {
        let resultText = `üèÅ Game Over!<br>Your Score: <strong>${this.p_run}</strong><br>Computer Score: <strong>${this.c_run}</strong><br>`;
        if (result === 'win' || (this.p_run > this.c_run && !result)) {
          resultText += "üéâ You win!";
          this.playSound('win');
        } else if (result === 'lose' || (this.c_run > this.p_run && !result)) {
          resultText += "üíî You lose!";
          this.playSound('lose');
        } else {
          resultText += "ü§ù It's a tie!";
        }
        this.messageBox.innerHTML = resultText;
        document.getElementById('game-section').classList.add('hidden');

        // Log the score when game ends
        logScore(`Player: ${this.p_run} | Computer: ${this.c_run} | Result: ${result}`);
      }

      win() {
        this.endGame('win');
      }

      lose() {
        this.endGame('lose');
      }

      playSound(type) {
        document.getElementById(type === 'win' ? 'clapssound' : 'losinghorn').play();
      }

      resetGame() {
        this.p_run = 0;
        this.c_run = 0;
        this.secondPhase = false;
        this.target = null;
        this.gamePhase = 'toss';
        this.prevMoves = [];
        this.sameChoiceCount = 0;
        this.lastPlayerInput = null;
        this.updateScores();
        this.playerChoiceDisplay.textContent = "-";
        this.computerChoiceDisplay.textContent = "-";
        this.messageBox.textContent = "Welcome! Please login first.";
        this.gameStatus.textContent = '';
        document.getElementById('game-section').classList.add('hidden');
        document.getElementById('toss-section').classList.add('hidden');
        document.getElementById('choice-section').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');
      }

      showPopup(message) {
        const popup = document.createElement("div");
        popup.className = "rainbow-popup";
        popup.innerText = message;
        document.getElementById("popup-container").appendChild(popup);
        setTimeout(() => popup.remove(), 6000);
      }

      animateOut() {
        this.container.classList.add("shake");
        setTimeout(() => this.container.classList.remove("shake"), 600);
      }

      captureAndShare() {
        this.screenshotBtn.disabled = true;

        html2canvas(document.getElementById('main-container'), {
          useCORS: true,
          allowTaint: true,
          logging: true,
        })
        .then(canvas => {
          try {
            this.shareImageWhatsApp(canvas.toDataURL('image/png'));
          } catch (shareError) {
            alert("Error sharing. See console.");
          }
        })
        .catch(error => {
          alert("Screenshot failed. See console.");
        })
        .finally(() => {
          this.screenshotBtn.disabled = false;
        });
      }

      shareImageWhatsApp(imgData) {
        if (!imgData) {
          alert("No image data to share.");
          return;
        }

        if (navigator.share) {
          const byteString = atob(imgData.split(',')[1]);
          const mimeString = imgData.split(',')[0].split(':')[1].split(';')[0];
          const ab = new ArrayBuffer(byteString.length);
          const ia = new Uint8Array(ab);
          for (let i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
          }
          const blob = new Blob([ab], { type: mimeString });
          const file = new File([blob], "game_screenshot.png", { type: mimeString });

          navigator.share({
            files: [file],
            title: 'Odd or Even Cricket Game Result',
            text: 'Check out my score!',
          })
          .then(() => {})
          .catch(() => {});
        } else {
          window.open(imgData, '_blank');
        }
      }
    }

    let game;
    document.addEventListener('DOMContentLoaded', () => {
      game = new HandCricketGame();
    });

    function toggleTheme() { game.toggleTheme(); }
    function toggleDifficulty() { game.toggleDifficulty(); }
    function setDifficulty(level) { game.setDifficulty(level); }
    function toss(playerToss) { game.toss(playerToss); }
    function setChoice(choice) { game.setChoice(choice); }
    function playRound() { game.playRound(); }
    function resetGame() { game.resetGame(); }
    function captureAndShare() { game.captureAndShare(); }
  </script>
</body>
</html>
