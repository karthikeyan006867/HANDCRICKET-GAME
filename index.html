<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Odd or Even Cricket Game</title>
  <style>
    :root {
      --bg-color: #000;
      --text-color: #fff;
      --container-bg: #fff;
      --container-text: #000;
      --score-bg: #f1f3f5;
    }

    body.dark {
      --bg-color: #000;
      --text-color: #fff;
      --container-bg: #fff;
      --container-text: #000;
      --score-bg: #f1f3f5;
    }

    body.light {
      --bg-color: #f5f5f5;
      --text-color: #000;
      --container-bg: #ffffff;
      --container-text: #000;
      --score-bg: #e0e0e0;
    }

    body.purple {
      --bg-color: #7F00FF;
      --text-color: #fff;
      --container-bg: #ffffff;
      --container-text: #000;
      --score-bg: #f3e9ff;
    }

    body.rainbow {
      background: linear-gradient(270deg, red, orange, yellow, green, blue, indigo, violet, red);
      background-size: 1400% 1400%;
      animation: rainbowBG 12s linear infinite;
    }

    @keyframes rainbowBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      20% { transform: translateX(-5px); }
      40% { transform: translateX(5px); }
      60% { transform: translateX(-5px); }
      80% { transform: translateX(5px); }
      100% { transform: translateX(0); }
    }

    .shake {
      animation: shake 0.5s;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      transition: background-color 0.4s ease, color 0.4s ease;
    }

    .container {
      max-width: 490px;
      margin: auto;
      background-color: var(--container-bg);
      color: var(--container-text);
      padding: 25px 30px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      color: red;
      margin-top: 10px;
    }

    .top-controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    button {
      margin: 5px;
      padding: 10px 18px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background: #007bff;
      color: white;
      transition: background-color 0.3s ease;
    }

    #message-box {
      background: #eef2f7;
      color: #000;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      min-height: 50px;
      font-weight: 600;
      text-align: center;
    }

    .scoreboard {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      background: var(--score-bg);
      color: #000;
      padding: 10px 15px;
      border-radius: 5px;
    }

    .choices-display {
      margin-top: 15px;
      display: flex;
      justify-content: space-between;
      font-weight: 500;
      color: #000;
    }

    #player-run {
      width: 80px;
      padding: 6px;
      font-size: 16px;
      margin-right: 8px;
    }

    .center-buttons {
      text-align: center;
      margin: 15px 0;
    }

    .difficulty-box {
      background-color: #ffe;
      color: #000;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
      text-align: center;
      display: none;
    }

    .difficulty-box button.selected {
      background-color: #dc3545;
    }

    .rainbow-popup {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff0;
      padding: 12px 25px;
      color: #000;
      font-weight: bold;
      border: 2px solid #000;
      border-radius: 10px;
      animation: fadeOut 5s forwards;
      z-index: 1000;
    }

    @keyframes fadeOut {
      0% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; display: none; }
    }

    #game-status {
      text-align: center;
      font-weight: bold;
      margin: 10px 0;
    }

    #share-btn {
      display: none;
      background-color: #25D366;
    }
    
    .screenshot-preview {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .screenshot-preview img {
      max-width: 90%;
      max-height: 90%;
      border: 5px solid white;
      border-radius: 10px;
    }
    
    .screenshot-preview .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
    }
    
    .screenshot-preview .download-btn {
      position: absolute;
      bottom: 20px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body class="dark">
  <div class="container" id="main-container">
    <div class="top-controls">
      <button onclick="toggleDifficulty()">üß† Difficulty</button>
      <button onclick="toggleTheme()">üé® Change Theme</button>
    </div>

    <h2>Odd or Even Cricket Game</h2>

    <div id="message-box">Welcome! Choose HEAD or TAILS to start the toss.</div>

    <div class="difficulty-box" id="difficulty-box">
      <p>Select difficulty level:</p>
      <button onclick="setDifficulty('easy')" id="easy-btn">Easy</button>
      <button onclick="setDifficulty('medium')" id="medium-btn">Medium</button>
      <button onclick="setDifficulty('hard')" id="hard-btn">Hard</button>
    </div>

    <div id="toss-section" class="center-buttons">
      <button onclick="toss('head')">HEAD</button>
      <button onclick="toss('tails')">TAILS</button>
    </div>

    <div id="choice-section" class="center-buttons" style="display:none;">
      <p>Choose your role:</p>
      <button onclick="setChoice('batting')">Batting</button>
      <button onclick="setChoice('bowling')">Bowling</button>
    </div>

    <div id="game-section" style="display:none;">
      <div id="game-status"></div>
      <div class="center-buttons">
        <input type="number" id="player-run" min="0" max="10" placeholder="0‚Äì10" />
        <button onclick="playRound()">Play</button>
      </div>

      <div class="choices-display">
        <div>Your choice: <span id="player-choice-display">-</span></div>
        <div>Computer choice: <span id="computer-choice-display">-</span></div>
      </div>

      <div class="scoreboard">
        <div>Your Score: <span id="player-score">0</span></div>
        <div>Computer Score: <span id="computer-score">0</span></div>
      </div>
    </div>

    <div class="center-buttons">
      <button onclick="resetGame()" style="background-color: #dc3545;">üîÅ Reset Game</button>
      <button id="screenshot-btn" onclick="captureAndShare()" style="background-color: #00a86b;">üì∏ Share Screenshot</button>
      <a id="share-btn" target="_blank">üì§ Share via WhatsApp</a>
    </div>

    <audio id="clapssound" src="https://assets.mixkit.co/sfx/preview/mixkit-applause-500.mp3"></audio>
    <audio id="losinghorn" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>
  </div>

  <div id="popup-container"></div>

  <script>
    const gameURL = "https://handcricket-game-g-in.onecompiler.app";

    let difficulty = 'easy';
    let themeClickCount = 0;
    let p_run = 0, c_run = 0;
    let playerChoice = '', gamePhase = 'toss', secondPhase = false;
    let prevMoves = [], sameChoiceCount = 0, lastPlayerInput = null;

    const playerRunInput = document.getElementById('player-run');
    const playerScoreDisplay = document.getElementById('player-score');
    const computerScoreDisplay = document.getElementById('computer-score');
    const playerChoiceDisplay = document.getElementById('player-choice-display');
    const computerChoiceDisplay = document.getElementById('computer-choice-display');
    const messageBox = document.getElementById('message-box');
    const gameStatus = document.getElementById('game-status');
    const shareBtn = document.getElementById('share-btn');
    const screenshotBtn = document.getElementById('screenshot-btn');
    const container = document.getElementById('main-container');

    document.addEventListener("keydown", function (e) {
      if (e.key === "Enter") playRound();
      if (e.key === "Shift") resetGame();
    });

    function toggleTheme() {
      const body = document.body;
      themeClickCount++;
      
      // Easter egg: Rainbow theme after 9 clicks
      if (themeClickCount === 9) {
        body.className = 'rainbow';
        showPopup("üåà Rainbow Theme Unlocked!");
        return;
      }
      
      const themes = ['dark', 'light', 'purple'];
      const currentTheme = body.className;
      let nextIndex = 0;
      
      // Find current theme index
      for (let i = 0; i < themes.length; i++) {
        if (currentTheme === themes[i]) {
          nextIndex = (i + 1) % themes.length;
          break;
        }
      }
      
      body.className = themes[nextIndex];
      showPopup(`Theme changed to ${themes[nextIndex].charAt(0).toUpperCase() + themes[nextIndex].slice(1)}`);
    }

    function toggleDifficulty() {
      const box = document.getElementById("difficulty-box");
      box.style.display = (box.style.display === "block") ? "none" : "block";
    }

    function setDifficulty(level) {
      difficulty = level;
      document.getElementById("difficulty-box").style.display = "none";
      ["easy", "medium", "hard"].forEach(id => {
        document.getElementById(`${id}-btn`).classList.remove("selected");
      });
      document.getElementById(`${level}-btn`).classList.add("selected");
      // Show a message to confirm difficulty change
      showPopup(`Difficulty set to ${level.charAt(0).toUpperCase() + level.slice(1)}`);
    }

    function toss(playerToss) {
      const compToss = Math.random() < 0.5 ? 'head' : 'tails';
      if (playerToss === compToss) {
        messageBox.innerHTML = `You chose <strong>${playerToss}</strong>, Computer chose <strong>${compToss}</strong>.<br>You won the toss! Choose to Bat or Bowl.`;
        document.getElementById('toss-section').style.display = 'none';
        document.getElementById('choice-section').style.display = 'block';
      } else {
        const compRole = Math.random() < 0.5 ? 'batting' : 'bowling';
        playerChoice = (compRole === 'batting') ? 'bowling' : 'batting';
        gamePhase = playerChoice;
        messageBox.innerHTML = `Computer won the toss and chose to ${compRole}. You are ${playerChoice}.`;
        document.getElementById('toss-section').style.display = 'none';
        setTimeout(startGame, 1500);
      }
    }

    function setChoice(choice) {
      playerChoice = choice;
      gamePhase = choice;
      document.getElementById('choice-section').style.display = 'none';
      startGame();
    }

    function startGame() {
      document.getElementById('game-section').style.display = 'block';
      gameStatus.textContent = `You are ${playerChoice}${secondPhase ? " (2nd Innings)" : ""}`;
      playerRunInput.focus();
    }

    function generateComputerMove() {
      if (difficulty === 'easy') return Math.floor(Math.random() * 11);
      if (difficulty === 'medium') {
        const bias = Math.random() < 0.3 ? prevMoves[prevMoves.length - 1] || Math.floor(Math.random() * 11) : Math.floor(Math.random() * 11);
        return Math.max(0, Math.min(10, bias));
      }
      if (difficulty === 'hard') {
        const freq = {};
        prevMoves.forEach(n => freq[n] = (freq[n] || 0) + 1);
        const sorted = Object.entries(freq).sort((a,b)=>b[1]-a[1]);
        const predict = sorted.length ? parseInt(sorted[0][0]) : Math.floor(Math.random() * 11);
        return Math.max(0, Math.min(10, predict + (Math.random() < 0.5 ? 0 : (Math.random() < 0.5 ? 1 : -1))));
      }
    }

    function playRound() {
      const val = parseInt(playerRunInput.value);
      if (isNaN(val) || val < 0 || val > 10) {
        messageBox.innerText = "Enter a number between 0 and 10.";
        playerRunInput.classList.add('shake');
        setTimeout(() => playerRunInput.classList.remove('shake'), 500);
        return;
      }

      // Check for repeated inputs
      if (val === lastPlayerInput) {
        sameChoiceCount++;
        if (sameChoiceCount === 3) {
          showPopup("‚ö† Warning: Don't repeat the same number!");
          playerRunInput.classList.add('shake');
          setTimeout(() => playerRunInput.classList.remove('shake'), 500);
        }
        if (sameChoiceCount === 4) {
          showPopup("üò¨ Be careful! Repeating again will get you OUT!");
          playerRunInput.classList.add('shake');
          setTimeout(() => playerRunInput.classList.remove('shake'), 500);
        }
      } else {
        sameChoiceCount = 1;
        lastPlayerInput = val;
      }

      // Check if player is out due to repeated inputs
      if (sameChoiceCount >= 5 && gamePhase === 'batting') {
        messageBox.innerHTML = "‚ùå You used the same number 5 times! You're out!";
        playSound('lose');
        animateOut();
        if (!secondPhase) {
          secondPhase = true;
          playerChoice = 'bowling';
          gamePhase = 'bowling';
          setTimeout(() => {
            messageBox.innerText = "You are out! Now Bowling ‚Äì Defend your score!";
            startGame();
          }, 1500);
        } else {
          endGame();
        }
        playerRunInput.value = '';
        return;
      }

      // Generate computer move
      const comp = generateComputerMove();
      const isOut = val === comp;
      prevMoves.push(val);
      playerChoiceDisplay.textContent = val;
      computerChoiceDisplay.textContent = comp;

      // Game logic based on current phase
      if (gamePhase === 'batting') {
        if (isOut) {
          playSound('lose');
          animateOut();
          if (!secondPhase) {
            secondPhase = true;
            playerChoice = 'bowling';
            gamePhase = 'bowling';
            setTimeout(() => {
              messageBox.innerText = "You are out! Now Bowling ‚Äì Defend your score!";
              startGame();
            }, 1000);
          } else {
            endGame();
          }
        } else {
          // If player chooses 0, they get the computer's score
          p_run += val === 0 ? comp : val;
          updateScores();
          if (secondPhase && p_run > c_run) {
            win();
          }
        }
      } else { // Bowling phase
        if (isOut) {
          playSound('lose');
          animateOut();
          if (!secondPhase) {
            secondPhase = true;
            playerChoice = 'batting';
            gamePhase = 'batting';
            setTimeout(() => {
              messageBox.innerText = "Computer is out! Now Batting ‚Äì Chase the score!";
              startGame();
            }, 1000);
          } else {
            endGame();
          }
        } else {
          c_run += comp;
          updateScores();
          if (secondPhase && c_run > p_run) {
            lose();
          }
        }
      }

      playerRunInput.value = '';
      playerRunInput.focus();
    }

    function updateScores() {
      playerScoreDisplay.textContent = p_run;
      computerScoreDisplay.textContent = c_run;
      
      // Add animation to score updates
      playerScoreDisplay.classList.add('shake');
      computerScoreDisplay.classList.add('shake');
      setTimeout(() => {
        playerScoreDisplay.classList.remove('shake');
        computerScoreDisplay.classList.remove('shake');
      }, 500);
    }

    function endGame() {
      let result = `üèÅ Game Over!<br>Your Score: <strong>${p_run}</strong><br>Computer Score: <strong>${c_run}</strong><br>`;
      
      if (p_run > c_run) {
        result += "üéâ You win!";
        playSound('win');
        container.classList.add('win-animation');
      } else if (c_run > p_run) {
        result += "üíî You lose!";
        playSound('lose');
        container.classList.add('lose-animation');
      } else {
        result += "ü§ù It's a tie!";
        container.classList.add('tie-animation');
      }
      
      messageBox.innerHTML = result;
      document.getElementById('game-section').style.display = 'none';
      
      // Show share button after game ends
      shareBtn.style.display = "inline-block";
      
      // Remove animation classes after animation completes
      setTimeout(() => {
        container.classList.remove('win-animation', 'lose-animation', 'tie-animation');
      }, 2000);
    }

    function win() {
      endGame();
    }

    function lose() {
      endGame();
    }

    function playSound(type) {
      const soundElement = document.getElementById(type === 'win' ? 'clapssound' : 'losinghorn');
      if (soundElement) {
        soundElement.play().catch(error => {
          console.error(`Error playing ${type} sound:`, error);
          // Fallback: show a visual notification if sound fails
          showPopup(type === 'win' ? "üéâ You win!" : "üíî You lose!");
        });
      } else {
        console.error(`Sound element for ${type} not found`);
        showPopup(type === 'win' ? "üéâ You win!" : "üíî You lose!");
      }
    }

    function resetGame() {
      p_run = 0; c_run = 0; secondPhase = false;
      gamePhase = 'toss'; prevMoves = [];
      sameChoiceCount = 0; lastPlayerInput = null;
      updateScores();
      playerChoiceDisplay.textContent = "-";
      computerChoiceDisplay.textContent = "-";
      messageBox.textContent = "Welcome! Choose HEAD or TAILS to start the toss.";
      gameStatus.textContent = '';
      document.getElementById('game-section').style.display = 'none';
      document.getElementById('toss-section').style.display = 'block';
      document.getElementById('choice-section').style.display = 'none';
      shareBtn.style.display = "none";
    }

    function showPopup(message) {
      const popup = document.createElement("div");
      popup.className = "rainbow-popup";
      popup.innerText = message;
      document.getElementById("popup-container").appendChild(popup);
      setTimeout(() => popup.remove(), 6000);
    }

    function animateOut() {
      container.classList.add("shake");
      setTimeout(() => container.classList.remove("shake"), 600);
    }

    function captureAndShare() {
      console.log("captureAndShare() called");
      
      // Disable button to prevent multiple clicks
      screenshotBtn.disabled = true;
      
      // Show loading message
      const loadingMessage = showPopup("Preparing screenshot...");
      
      // Check if html2canvas is available
      if (typeof html2canvas === 'undefined') {
        console.error("html2canvas is not loaded");
        showPopup("Screenshot library not loaded. Please try again later.");
        screenshotBtn.disabled = false;
        return;
      }
      
      try {
        // Use html2canvas to capture the container
        html2canvas(document.getElementById('main-container'), {
          useCORS: true,
          allowTaint: true,
          logging: false,
          scale: 2, // Higher resolution
          backgroundColor: null
        })
        .then(canvas => {
          console.log("html2canvas succeeded");
          
          // Remove loading message
          if (loadingMessage && loadingMessage.parentNode) {
            loadingMessage.parentNode.removeChild(loadingMessage);
          }
          
          // Create a preview of the screenshot
          showScreenshotPreview(canvas);
          
          // Re-enable button
          screenshotBtn.disabled = false;
        })
        .catch(error => {
          console.error("html2canvas failed:", error);
          
          // Remove loading message
          if (loadingMessage && loadingMessage.parentNode) {
            loadingMessage.parentNode.removeChild(loadingMessage);
          }
          
          // Show error message
          showPopup("Screenshot failed. Please try again.");
          
          // Re-enable button
          screenshotBtn.disabled = false;
        });
      } catch (error) {
        console.error("Error in captureAndShare:", error);
        
        // Remove loading message
        if (loadingMessage && loadingMessage.parentNode) {
          loadingMessage.parentNode.removeChild(loadingMessage);
        }
        
        // Show error message
        showPopup("Screenshot failed. Please try again.");
        
        // Re-enable button
        screenshotBtn.disabled = false;
      }
    }

    function showScreenshotPreview(canvas) {
      // Create a preview modal
      const preview = document.createElement('div');
      preview.className = 'screenshot-preview';
      
      // Create close button
      const closeBtn = document.createElement('button');
      closeBtn.className = 'close-btn';
      closeBtn.innerHTML = '√ó';
      closeBtn.onclick = function() {
        document.body.removeChild(preview);
      };
      
      // Create image element
      const img = document.createElement('img');
      img.src = canvas.toDataURL('image/png');
      
      // Create download button
      const downloadBtn = document.createElement('button');
      downloadBtn.className = 'download-btn';
      downloadBtn.innerHTML = 'Download Image';
      downloadBtn.onclick = function() {
        const link = document.createElement('a');
        link.download = 'cricket-game-result.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      };
      
      // Add elements to preview
      preview.appendChild(closeBtn);
      preview.appendChild(img);
      preview.appendChild(downloadBtn);
      
      // Add preview to body
      document.body.appendChild(preview);
      
      // Try to share via WhatsApp if possible
      shareImageWhatsApp(canvas.toDataURL('image/png'));
    }

    function shareImageWhatsApp(imgData) {
      try {
        // If Web Share API is available, use it
        if (navigator.share && navigator.canShare({ files: [] })) {
          // Convert data URL to blob
          fetch(imgData)
            .then(res => res.blob())
            .then(blob => {
              const file = new File([blob], "cricket-game-result.png", { type: "image/png" });
              
              if (navigator.canShare({ files: [file] })) {
                navigator.share({
                  files: [file],
                  title: 'Odd or Even Cricket Game Result',
                  text: `Check out my score! I scored ${p_run} runs against the computer's ${c_run} runs.`,
                })
                .then(() => console.log('Shared successfully'))
                .catch((error) => console.log('Error sharing', error));
              } else {
                // Fallback to WhatsApp web
                shareViaWhatsAppWeb();
              }
            })
            .catch(error => {
              console.error('Error converting image:', error);
              // Fallback to WhatsApp web
              shareViaWhatsAppWeb();
            });
        } else {
          // Fallback to WhatsApp web
          shareViaWhatsAppWeb();
        }
      } catch (error) {
        console.error('Error sharing:', error);
        showPopup("Sharing failed. Please try again.");
      }
    }

    function shareViaWhatsAppWeb() {
      const text = `Check out my score! I scored ${p_run} runs against the computer's ${c_run} runs in the Odd or Even Cricket Game.`;
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
      
      // Update the share button
      shareBtn.href = whatsappUrl;
      shareBtn.style.display = "inline-block";
      
      // Show message
      showPopup("Click the WhatsApp button to share your score!");
    }

    // Initialize the game when the page loads
    window.onload = function() {
      // Set initial difficulty
      setDifficulty('easy');
      
      // Focus on the input when it's visible
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
            const gameSection = document.getElementById('game-section');
            if (gameSection.style.display !== 'none') {
              playerRunInput.focus();
            }
          }
        });
      });
      
      observer.observe(document.getElementById('game-section'), {
        attributes: true
      });
    };
  </script>
</body>
</html>
